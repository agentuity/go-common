//go:build ignore

package main

import (
	"fmt"
	"os"
	"strings"

	"github.com/agentuity/go-common/network"
)

func main() {
	services := []string{"aether", "catalyst", "otel"}

	output := `// Code generated by go generate; DO NOT EDIT.
// To regenerate, run: go generate ./network

package network

`

	mapping := `var Services = map[string]string{`
	mapping += "\n"

	for _, service := range services {
		ip := genStaticServiceIP(service)
		varName := fmt.Sprintf("%sServiceIP", capitalize(service))
		output += fmt.Sprintf("const %s = \"%s\"\n", varName, ip)
		mapping += fmt.Sprintf("\t\"%s\": \"%s\",\n", ip, service)
	}

	mapping += `}`

	output += "\n" + mapping + "\n"

	mapping = `var Addresses = map[string]string{`
	mapping += "\n"

	for _, service := range services {
		ip := genStaticServiceIP(service)
		mapping += fmt.Sprintf("\t\"%s\": \"%s\",\n", service, ip)
	}

	mapping += `}`

	output += "\n" + mapping + "\n"

	serviceNet := genStaticServiceNetIP()

	output += fmt.Sprintf("\nvar ServiceSubnet = \"%s\"\n", serviceNet)

	err := os.WriteFile("static_generated.go", []byte(output), 0644)
	if err != nil {
		panic(err)
	}
}

func capitalize(s string) string {
	if len(s) == 0 {
		return s
	}
	return strings.ToUpper(s[:1]) + s[1:]
}

func genStaticServiceIP(serviceName string) string {
	addr := network.NewIPv6Address(network.RegionGlobal, network.NetworkPrivateServices, serviceName, "", "")
	return addr.String()
}

func genStaticServiceNetIP() string {
	addr := network.NewIPv6Address(network.RegionGlobal, network.NetworkPrivateServices, "", "", "")
	// 32 bits (first two hextets)
	// 12 bits (from the third hextet)
	// = 44 bits total.
	// ip := addr.String()
	// // Take the first 11 characters and ensure proper formatting
	// return fmt.Sprintf("%s0::/44", ip[:11])
	return addr.String()[0:11] + "0::/44"
}
